From 7c5db04d783ac054d96e178fae33fecbb3671b60 Mon Sep 17 00:00:00 2001
From: Todd Short <tshort@akamai.com>
Date: Mon, 26 Aug 2019 13:29:17 -0400
Subject: [PATCH 08/60] QUIC: Fix quic_transport constructors/parsers

---
 ssl/statem/extensions_clnt.c | 16 +++-------------
 ssl/statem/extensions_srvr.c | 16 +++-------------
 2 files changed, 6 insertions(+), 26 deletions(-)

diff --git a/ssl/statem/extensions_clnt.c b/ssl/statem/extensions_clnt.c
index 52742dc36a..3ae28e68dc 100644
--- a/ssl/statem/extensions_clnt.c
+++ b/ssl/statem/extensions_clnt.c
@@ -1208,10 +1208,8 @@ EXT_RETURN tls_construct_ctos_quic_transport_params(SSL *s, WPACKET *pkt,
     }
 
     if (!WPACKET_put_bytes_u16(pkt, TLSEXT_TYPE_quic_transport_parameters)
-            || !WPACKET_start_sub_packet_u16(pkt)
-            || !WPACKET_sub_memcpy_u16(pkt, s->ext.quic_transport_params,
-                                       s->ext.quic_transport_params_len)
-            || !WPACKET_close(pkt)) {
+        || !WPACKET_sub_memcpy_u16(pkt, s->ext.quic_transport_params,
+                                   s->ext.quic_transport_params_len)) {
         SSLfatal(s, SSL_AD_INTERNAL_ERROR, ERR_R_INTERNAL_ERROR);
         return EXT_RETURN_FAIL;
     }
@@ -2008,19 +2006,11 @@ int tls_parse_stoc_psk(SSL *s, PACKET *pkt, unsigned int context, X509 *x,
 int tls_parse_stoc_quic_transport_params(SSL *s, PACKET *pkt, unsigned int context,
                                          X509 *x, size_t chainidx)
 {
-    PACKET trans_param;
-
-    if (!PACKET_as_length_prefixed_2(pkt, &trans_param)
-            || PACKET_remaining(&trans_param) == 0) {
-        SSLfatal(s, SSL_AD_DECODE_ERROR, SSL_R_BAD_EXTENSION);
-        return 0;
-    }
-
     OPENSSL_free(s->ext.peer_quic_transport_params);
     s->ext.peer_quic_transport_params = NULL;
     s->ext.peer_quic_transport_params_len = 0;
 
-    if (!PACKET_memdup(&trans_param,
+    if (!PACKET_memdup(pkt,
                        &s->ext.peer_quic_transport_params,
                        &s->ext.peer_quic_transport_params_len)) {
         SSLfatal(s, SSL_AD_INTERNAL_ERROR, ERR_R_INTERNAL_ERROR);
diff --git a/ssl/statem/extensions_srvr.c b/ssl/statem/extensions_srvr.c
index 6b58b9b9e4..f525d9e897 100644
--- a/ssl/statem/extensions_srvr.c
+++ b/ssl/statem/extensions_srvr.c
@@ -1237,19 +1237,11 @@ int tls_parse_ctos_post_handshake_auth(SSL *s, PACKET *pkt,
 int tls_parse_ctos_quic_transport_params(SSL *s, PACKET *pkt, unsigned int context,
                                          X509 *x, size_t chainidx)
 {
-    PACKET trans_param;
-
-    if (!PACKET_as_length_prefixed_2(pkt, &trans_param)
-            || PACKET_remaining(&trans_param) == 0) {
-        SSLfatal(s, SSL_AD_DECODE_ERROR, SSL_R_BAD_EXTENSION);
-        return 0;
-    }
-
     OPENSSL_free(s->ext.peer_quic_transport_params);
     s->ext.peer_quic_transport_params = NULL;
     s->ext.peer_quic_transport_params_len = 0;
 
-    if (!PACKET_memdup(&trans_param,
+    if (!PACKET_memdup(pkt,
                        &s->ext.peer_quic_transport_params,
                        &s->ext.peer_quic_transport_params_len)) {
         SSLfatal(s, SSL_AD_INTERNAL_ERROR, ERR_R_INTERNAL_ERROR);
@@ -1954,10 +1946,8 @@ EXT_RETURN tls_construct_stoc_quic_transport_params(SSL *s, WPACKET *pkt,
     }
 
     if (!WPACKET_put_bytes_u16(pkt, TLSEXT_TYPE_quic_transport_parameters)
-            || !WPACKET_start_sub_packet_u16(pkt)
-            || !WPACKET_sub_memcpy_u16(pkt, s->ext.quic_transport_params,
-                                       s->ext.quic_transport_params_len)
-            || !WPACKET_close(pkt)) {
+        || !WPACKET_sub_memcpy_u16(pkt, s->ext.quic_transport_params,
+                                   s->ext.quic_transport_params_len)) {
         SSLfatal(s, SSL_AD_INTERNAL_ERROR, ERR_R_INTERNAL_ERROR);
         return EXT_RETURN_FAIL;
     }
-- 
2.40.0.rc0

